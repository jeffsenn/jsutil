!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(r){if(Array.isArray(r))return r.forEach((function(t,n){r[n]=e(t)})),r;if("object"==typeof r){var t={};return Object.keys(r).sort().forEach((function(n){t[n]=e(r[n])})),t}return r}function r(e){return Object.getOwnPropertyNames(e).forEach((function(t){!e.hasOwnProperty(t)||null===e[t]||"object"!=typeof e[t]&&"function"!=typeof e[t]||Object.isFrozen(e[t])||r(e[t])})),Object.freeze(e),e}function t(e){return"string"==typeof e||e instanceof String}function n(e){return e&&e[""]&&1==Object.keys(e).length?e[""][0]:void 0}const a=r({"":["ErrTok"]}),i=r({"":["Null"]});class o{constructor(e){if("Binary"===n(e))e=e[""][1];else if(!t(e))throw Error("TBD: non base64 data");this[""]=["Binary",e],r(this)}static isa(e){return"Binary"===n(e)}}function s(e){return e&&"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e)}class c{constructor(e){if(void 0===e)e=(new Date).toISOString();else if("Date"===n(e))e=e[""][1];else if(s(e))e=e.toISOString();else{const r=new Date(e);if(isNaN(r))throw Error("not convertable to date")}this[""]=["Date",e],r(this)}toDate(){return new Date(this[""][1])}static isa(e){return"Date"===n(e)}}class u{constructor(e){if(void 0===e)e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{let r=16*Math.random()|0;return("x"==e?r:3&r|8).toString(16)}));else if("UUID"==n(e))e=e[""][1];else if(!t(e)){if(!e.toString)throw"not a string";e=e.toString()}this[""]=["UUID",e],Object.freeze(this)}static isa(e){return"UUID"==n(e)}toString(){return this[""][1]}}var f={UUID:u,Binary:o,Date:c};var l={isSpecial:n,isString:t,UUID:u,ErrTok:a,Null:i,Binary:o,deepEdit:function e(r,t,n,a){return a||(a=0),a>=t.length?n:(r=isNaN(t[a])?"object"==typeof r?{...r}:{}:Array.isArray(r)?r.slice():[],val=e(r[t[a]],t,n,a+1),void 0===val||null===val?delete r[t[a]]:r[t[a]]=val,r)},deepFreeze:r,deepFreezeAndClassify:function e(r){var t=Object.getOwnPropertyNames(r);if(t.forEach((function(t){!r.hasOwnProperty(t)||null===r[t]||"object"!=typeof r[t]&&"function"!=typeof r[t]||Object.isFrozen(r[t])||e(r[t])})),1===t.length&&""===t[0]&&Array.isArray(r[""])){var n=f[r[""][0]];n&&r.__proto__===Object.prototype&&(r.__proto__=n.prototype)}return Object.freeze(r),r},stringifyKeysInOrder:function(r){var t=e(r);return JSON.stringify(t)},shallowCopy:function(e){return Array.isArray(e)?e.slice():"object"==typeof e?{...e}:e},orderedJSON:function e(r){return Array.isArray(r)?"["+r.map(e).join(",")+"]":n(r)||"object"!=typeof r?JSON.stringify(r):"{"+Object.entries(r).map((function(r,t){return'"'+r+'":'+e(t)})).sort().join(",")+"}"},parseJSON:function(e){return JSON.parse(e,(function(e,r){var t;return r[""]&&(t=f[r[""][0]])&&1==Object.keys(r).length?new t(r):r}))},deepMergeUpdates:function(e,r){return function e(r,t){if(r===t)return t;if(typeof r!=typeof t)return r;if(r instanceof Date)return t instanceof Date&&r.valueOf()==t.valueOf()?t:r;if(Array.isArray(r)){if(Array.isArray(t)){let a;for(var n in r)if(a)a[n]=e(r[n],t[n]);else{let i=e(r[n],t[n]);i!==t[n]&&(a=t.slice(0,r.length),a[n]=i)}return a||(r.length==t.length?t:t.slice(0,r.length))}return r}if("object"==typeof r){let n=!1,i={...r},o=0;for(var a in i){o+=1;let r=i[a]=e(i[a],t[a]);n||r===t[a]||(n=!0)}return n||Object.keys(t).length!==o?i:t}return r}(e,r)},UTF8ArrayToStr:function(e){var r,t,n,a,i,o;for(r="",n=e.length,t=0;t<n;)switch((a=e[t++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(a);break;case 12:case 13:i=e[t++],r+=String.fromCharCode((31&a)<<6|63&i);break;case 14:i=e[t++],o=e[t++],r+=String.fromCharCode((15&a)<<12|(63&i)<<6|(63&o)<<0)}return r},toUTF8Array:function(e){for(var r=[],t=0;t<e.length;t++){var n=e.charCodeAt(t);n<128?r.push(n):n<2048?r.push(192|n>>6,128|63&n):n<55296||n>=57344?r.push(224|n>>12,128|n>>6&63,128|63&n):(t++,n=65536+((1023&n)<<10|1023&e.charCodeAt(t)),r.push(240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n))}return r},asString:function(e){return"string"==typeof e?e:""+e},asNumber:function(e){return null===x?NaN:+e},DateValue:c,isValidDate:s};const p=require("jsep");p.removeIdentifierChar("@"),p.removeIdentifierChar("_"),p.addBinaryOp("contains"),p.addBinaryOp("contains1of");const y=(e,r)=>e.indexOf(r)>=0||e.hasOwnProperty(r),h={"+":(e,r)=>e+r,"-":(e,r)=>e-r,"*":(e,r)=>e*r,"/":(e,r)=>e/r,"%":(e,r)=>e%r,"&&":(e,r)=>e&&r,"||":(e,r)=>e||r,"==":(e,r)=>e==r,"===":(e,r)=>e===r,contains:y,contains1of:(e,r)=>e.map((t=>y(r,e))).any()},g={"-":e=>-e,"+":e=>+e,"!":e=>!e};async function d(e,r,t){return async function e(r){switch(r.type){case"MemberExpression":const n=r.computed?await e(r.property):"Literal"===r.property.type?r.property.value:"Identifier"===r.property.type?r.property.name:null;if(!n)throw"bad member expr: "+JSON.stringify(r.property);return t(await e(r.object),n);case"ArrayExpression":return Promise.all(r.elements.map(e));case"LogicalExpression":case"BinaryExpression":return h[r.operator](await e(r.left),await e(r.right));case"UnaryExpression":return g[r.operator](await e(r.argument));case"Literal":return r.value;case"Identifier":return t(null,r.name,!0)}}(e)}var m={parser:p,evaluate:function(e,r){return async function e(t){switch(t.type){case"MemberExpression":const n=t.computed?e(t.property):"Literal"===t.property.type?t.property.value:"Identifier"===t.property.type?t.property.name:null;if(!n)throw"bad member expr: "+JSON.stringify(t.property);return e(t.object)[n];case"ArrayExpression":return t.elements.map(e);case"LogicalExpression":case"BinaryExpression":return h[t.operator](e(t.left),await e(t.right));case"UnaryExpression":return g[t.operator](e(t.argument));case"Literal":return t.value;case"Identifier":return r[t.name]}}(e)},asyncEvaluate:d,grql:async function(e,r,t){const n=t&&t.isReference||(e=>!1),a=t&&t.fetchReferences,i=t&&t.findReference;function o(e,r){return Object.keys(r).reduce(((t,n)=>(t[n]=e[r[n]],t)),{})}if(t&&t.isReference){const r=e.filter(n);r.length>0&&await a(r)}const s=e.map((e=>[n(e)?i(e):e])),c=r.path.split(".").map((e=>e.split(":",2))),u={};async function f(e,r){class t{constructor(e){this.items=e}followMemberJoin(e){const r=this.items.reduce(((r,t)=>{const n=t[e];return n&&(Array.isArray(n)&&r.push.apply(r,n),r.push(n)),r}),[]);return 0==r.length?null:1==r.length?r[0]:r}}return d(e,0,(async function(e,o,s){return s&&(e=r),Array.isArray(e)&&n(e[0])&&(1==e.length?e=e[0]:(await a(e.filter(n)),e=new t(e.map((e=>n(e)?i(e):e))))),n(e)&&(void 0===i(e)&&await a([e]),e=i(e)),""===o||(e=e instanceof t?e.followMemberJoin(o):e?e[o]:null),e}))}await c.reduce((async(e,t,o)=>{if(t[1]&&(u[t[1]]=o),o>0||""!==t[0]){const e=function(e,r,t=!1){const a={};for(let o=0;o<e.length;o++){const s=e[o],c=s&&s[s.length-1],u=n(c)?i(c):c,f=u&&(Array.isArray(u)?u.map((e=>e[r])).flat():u[r]);if(f&&Array.isArray(f))for(let r=0;r<f.length;r++){const t=f[r];n(f[r])&&void 0===i(f[r])&&(a[f[r]]=null),r===f.length-1?s.push(t):(e.splice(o,0,[...s,t]),o+=1)}else f||t?(n(f)&&(a[f]=null),s.push(f)):(e.splice(o,1),o-=1)}return Object.keys(a)}(s,t[0],r.allowNull);e.length>0&&await a(e)}}),[]);const l=p(r.where);if(await async function(e,r){let t=0,n=0;for(;t<e.length;){const a=e[t];await r(a)&&(e[n++]=a),t++}return e.length=n,e}(s,(async e=>f(l,o(e,u)))),r.sortBy){const e=p(r.sortBy);await s.sort((async r=>await f(e,o(r,u))))}const y=p(r.return);return Promise.all(s.map((e=>f(y,o(e,u)))))}};module.exports={...l,...m}}));
